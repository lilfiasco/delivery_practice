{% extends 'base.html' %}

{% block content %}

<link rel="stylesheet" type="text/css" href="/static/css/cart.css">

{% load widget_tweaks %}

<a href="/menu" class="back-link mt-5 ml-5">
    <img class="back-icon" src="https://i.postimg.cc/wTmB78pf/Vector2.png">
    Вернуться к поиску
</a>

<div class="title-cart ml-4">
    <h2>Название франшизы</h2>
</div>

<div class="korzina">
    <p>
        Ваша корзина
    </p>
</div>

<div class="cart ml-6 mr-6 mt-3">
    <div class="col-12 mr-4 d-flex flex-row justify-content-between">

        <div id="cartItems" class="cart-items">

        </div>

        <div id="cartTitle" class="cart-title">

        </div>

        <!-- <div class="button-wrapper">
            <div class="quantity-wrapper mr-3">
                <button class="quantity-button" onclick="decreaseQuantity()">-</button>
                <p class="quantity-value">0</p>
                <button class="quantity-button" onclick="increaseQuantity()">+</button>
            </div>
        </div>

        <div id="cartPrice" class="cart-price">
            ...
        </div>

        <div>
            <img class="cart-icon"
                src="https://www.citypng.com/public/uploads/preview/rubbish-bin-basket-trash-white-icon-11637141431rrxgucag5m.png">
        </div> -->

        <div class="cart-modal ml-6">
            <p class="from-modal">Итого:</p>
            <p class="from-modal">Доставка:</p>
            <hr class="hr-cart">
            <p class="from-modal">Всего к оплате:</p>
            {% if user.is_authenticated %}
            <button type="button" class="cart-button" data-mdb-toggle="modal" data-mdb-target="#exampleModal">Оформить
                заказ</button>
            {% else %}
            <button class="cart-button" href="#">Оформить заказ</button>
            {% endif%}
            <button type="button" class="btn btn-primary" data-mdb-toggle="modal" data-mdb-target="#exampleModal">
                Launch demo modal
            </button>

            <!-- Modal -->
            <div class="modal fade left" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                            <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">Тут будут филды корзины</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary">Save changes</button>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                // Get the modal element
                const modal = document.getElementById('exampleModal');

                // Create a new Bootstrap Modal instance
                const bootstrapModal = new bootstrap.Modal(modal);

                // Open the modal when the button is clicked
                const triggerButton = document.querySelector('.btn-primary');
                triggerButton.addEventListener('click', function () {
                    bootstrapModal.show();
                });

                // Close the modal when the "Close" button is clicked
                const closeButton = document.querySelector('.btn-close');
                closeButton.addEventListener('click', function () {
                    bootstrapModal.hide();
                });
            </script>
        </div>
    </div>
</div>

{% if user.is_authenticated %}
<button class="cart-button" id="checkoutButton" type="button">Оформить заказ</button>
{% else %}
<button class="cart-button" type="button"><a href="{% url 'login' %}">Оформить заказ</a></button>
{% endif %}

<div id="cartItems" class="container">

</div>







<script>
    let quantityValue = 0;
  
    function decreaseQuantity() {
      if (quantityValue > 0) {
        quantityValue--;
        document.querySelector('.quantity-value').textContent = quantityValue;
      }
    }
  
    function increaseQuantity() {
      quantityValue++;
      document.querySelector('.quantity-value').textContent = quantityValue;
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    var cartItems = JSON.parse(localStorage.getItem("cart"));

    var cartItemsElement = document.getElementById("cartItems");
    for (var key in cartItems) {
        if (cartItems.hasOwnProperty(key)) {
            var item = cartItems[key];
            var title = item.title;
            var quantity = item.quantity;
            var image = item.image;
            var price = item.price;

            var container = document.createElement("div");
            container.classList.add("cartItemContainer");

            var img = document.createElement('img');
            img.src = "/media/" + image;
            img.width = 100;
            img.height = 100;
            img.classList.add("cartItemImage");

            var row = document.createElement("div");
            row.classList.add("row");

            var titleElement = document.createElement("div");
            titleElement.textContent = title;
            titleElement.classList.add("row-item-title");

            var quantityElement = document.createElement("div");
            // quantityElement.textContent = "Количество: ";
            quantityElement.classList.add("row-item-quantity");

            var quantityValue = document.createElement("span");
            quantityValue.textContent = quantity;
            quantityValue.classList.add("quantityValue");

            var decreaseButton = document.createElement("button");
            decreaseButton.textContent = "-";
            decreaseButton.classList.add("quantityButton");
            decreaseButton.addEventListener("click", decreaseQuantity);

            var increaseButton = document.createElement("button");
            increaseButton.textContent = "+";
            increaseButton.classList.add("quantityButton");
            increaseButton.addEventListener("click", increaseQuantity);

            var priceElement = document.createElement("div");
            priceElement.textContent = "Цена: " + price * quantity + " ТГ";
            priceElement.classList.add("row-item-price");

            var imageElement = document.createElement("img");
            imageElement.src = "https://i.postimg.cc/TwwwPzkw/bpmn-trash.png";
            imageElement.width = 30;
            imageElement.height = 30;
            imageElement.classList.add("deleteImage");

            row.appendChild(titleElement);
            row.appendChild(quantityElement);
            quantityElement.appendChild(decreaseButton);
            quantityElement.appendChild(quantityValue);
            quantityElement.appendChild(increaseButton);
            row.appendChild(priceElement);
            row.appendChild(imageElement);

            container.appendChild(img);
            container.appendChild(row);

            cartItemsElement.appendChild(container);
        }
    }
});


    function decreaseQuantity() {
        var quantityValue = parseInt(this.parentNode.querySelector(".quantityValue").textContent);
        if (quantityValue > 0) {
            quantityValue--;
            this.parentNode.querySelector(".quantityValue").textContent = quantityValue;
        }
    }

    function increaseQuantity() {
        var quantityValue = parseInt(this.parentNode.querySelector(".quantityValue").textContent);
        quantityValue++;
        this.parentNode.querySelector(".quantityValue").textContent = quantityValue;
    }

    document.getElementById("checkoutButton").addEventListener("click", function () {
        var cartItems = JSON.parse(localStorage.getItem("cart"));
        var data = [];

        for (var key in cartItems) {
            if (cartItems.hasOwnProperty(key)) {
                var item = cartItems[key];
                var foodId = key;
                var price = item.price;
                var quantity = item.quantity;
                var totalPrice = item.price * quantity;
                var user = "{{ user.id }}";  // Replace with the appropriate user identifier

                var order = {
                    food_id: foodId,
                    price: price,
                    quantity: quantity,
                    total_price: totalPrice,
                    user_id: user,
                };

                data.push(order);
            }
        }

        fetch('/order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',  // Include the CSRF token for Django
            },
            body: JSON.stringify(data),
        })
        .then(response => {
            if (response.ok) {
                console.log("Checkout successful");
            } else {
                console.error("Checkout failed");
            }
        })
        .catch(error => {
            console.error("An error occurred during checkout:", error);
        });
    });
</script>


{% endblock %}