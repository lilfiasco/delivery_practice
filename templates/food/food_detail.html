{% extends 'base.html' %}

{% block content %}

{% load widget_tweaks %}


<link rel="stylesheet" type="text/css" href="/static/css/food_detail.css">

<!-- <p style="color: aliceblue;"> Название: {{food.title}}</p>
<p style="color: aliceblue;"> Категория: {{food.category}}</p>
<p style="color: aliceblue;"> Цена: {{food.price}}</p>
<img src="/media/{{food.image}}"> -->


<!-- <h2>{{food.franchise.title}}</h2> -->

<a href="/menu" class="back-link mt-5 ml-5">
  <span class="arrow">&#8592;</span>
  Вернуться к поиску
</a>


<div class="food-franchise-title text-center mt-5 mb-5">
  <h2>{{ food.franchise.title }}</h2>
</div>

<div class="food-detail">
  <div class="food-image ml-5">
    <img class="food-photo" src="/media/{{food.image}}">
  </div>


  <div class="food-info">
    <div class="col-12 d-flex flex-row justify-content-between">
      <div class="food-title">
        <p class="f-title">{{food.title}}</p>
      </div>

      <div class="food-category">
        <p class="category">{{food.category}}</p>
      </div>
    </div>

    <div class="col-12 ">
      <div class="food-description">
        <p class="f-description">{{food.description}}</p>
      
        <div class="food-price">
          <p class="food-price-border">{{food.price}} ТГ</p>
        </div>
      </div>
    </div>
    <div class="col-12 d-flex flex-row justify-content-between">
      <div class="button-wrapper">
            <button class="quantity-button" onclick="changeQuantity(this, -1)">-</button>
              <span class="quantity-display" data-quantity="0">0</span>
          <button class="quantity-button" class="button-food" onclick="changeQuantity(this, 1)"  data-food-id="{{ food.id }}" data-food-title="{{ food.title }}" data-food-price="{{ food.price }}" data-food-image="{{ food.image }}" data-food-quantity="0" onclick="addToCart(this)">+</button>
      </div>
  
      <div class="button-wrapper">
          <button  type="button"  class="button-food" data-food-id="{{ food.id }}" data-food-title="{{ food.title }}" data-food-price="{{ food.price }}" data-food-image="{{ food.image }}" data-food-quantity="0" onclick="addToCart(this)">Добавить в корзину</button>
      </div>
    </div>
    </div>
  </div>
</div>


<script>
  var savedCart = JSON.parse(localStorage.getItem("cart")) || {};

  var foodItems = document.querySelectorAll('.button-food');
  foodItems.forEach(function(item) {
  var foodId = item.getAttribute("data-food-id");
  if (foodId in savedCart) {
      var quantity = savedCart[foodId].quantity;
      var quantityDisplay = item.parentNode.parentNode.querySelector(".quantity-display");
      if (quantityDisplay) {
      quantityDisplay.setAttribute("data-quantity", quantity);
      quantityDisplay.innerText = quantity;
      }
  }
  });

  var cart = JSON.parse(localStorage.getItem("cart")) || {};

  function addToCart(button,) {
    
      var foodId = button.getAttribute("data-food-id");
      var foodTitle = button.getAttribute("data-food-title");
      var foodPrice = parseFloat(button.getAttribute("data-food-price"));
      var foodImage = button.getAttribute("data-food-image");
      var foodQuantity = parseInt(button.getAttribute("data-food-quantity"));
      
      var quantityDisplay = button.parentNode.parentNode.querySelector(".quantity-display");
      var quantity = parseInt(quantityDisplay.getAttribute("data-quantity"));

      if (quantity > 0 ) {
          cart[foodId] = {
              title: foodTitle,
              price: foodPrice,
              quantity: quantity,
              image: foodImage
          };
          saveCartToLocalStorage();
          updateCartDisplay();

      }
      else {
          delete cart[foodId];
          saveCartToLocalStorage();
          updateCartDisplay();
      } 
  }

function changeQuantity(button, increment) {
var quantityDisplay = button.parentNode.querySelector(".quantity-display");
var currentQuantity = parseInt(quantityDisplay.getAttribute("data-quantity"));
var newQuantity = currentQuantity + increment;

if (newQuantity >= 0) {
  quantityDisplay.setAttribute("data-quantity", newQuantity);
  quantityDisplay.innerText = newQuantity;
  var foodId = button.parentNode.parentNode.querySelector(".button-food").getAttribute("data-food-id");

  if (newQuantity === 0 && foodId in cart) {
      delete cart[foodId]; // Remove the item from the cart
  } else {
      if (foodId in cart) {
          cart[foodId].quantity = newQuantity;
      } else {
          var foodTitle = button.parentNode.parentNode.querySelector(".button-food").getAttribute("data-food-title");
          var foodPrice = parseFloat(button.parentNode.parentNode.querySelector(".button-food").getAttribute("data-food-price"));
          var foodImage = button.parentNode.parentNode.querySelector(".button-food").getAttribute("data-food-image");

          cart[foodId] = {
              title: foodTitle,
              price: foodPrice,
              quantity: newQuantity,
              image: foodImage
          };
          debugger
      }
  }

  saveCartToLocalStorage();
  updateCartDisplay();
}
}


 
  function updateQuantityDisplay(container, quantity) {
      var quantityDisplay = container.querySelector(".quantity-display");
      quantityDisplay.innerText = quantity;
  }

  
  function updateCartDisplay() {
      var cartItemsDiv = document.getElementById("cart-items");
      cartItemsDiv.innerHTML = "";

      for (var foodId in cart) {
          var item = cart[foodId];
          var itemElement = document.createElement("div");
          itemElement.innerText = item.title + " - " + item.quantity + item.price;
          cartItemsDiv.appendChild(itemElement);
      }
  }


  function saveCartToLocalStorage() {
      localStorage.setItem("cart", JSON.stringify(cart));
  }


  if (Object.keys(cart).length > 0) {
      updateCartDisplay();
  }


  window.addEventListener("beforeunload", function() {
      saveCartToLocalStorage();
  });

  function checkout() {
      console.log(cart);
      localStorage.removeItem("cart");
  }
</script>



{%endblock%}